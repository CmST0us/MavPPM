# TODO

- [ ] replace: Usbmuxd -> usbmuxd
- [ ] 

# 基于移动端重力感应的无人机遥控系统

------------

# 摘要
1. 移动互联网发展，无人机普及
2. 在无人机爱好者中，有非常多的人喜欢自己组装一台无人机。
3. 本系统提出了一种可以使用移动设备（以iOS为例）的重力感应控制无人机的方法。通过此系统，使用者可以使用手机（以搭载iOS系统的设备为例）控制无人机。虽然本设计目的是使用重力感应控制无人机，但是在设计时，考虑到扩展和兼容性。使用者只需要更通过更新软件的方式，就可以实现更多的操控方式，例如使用外置手柄或者虚拟摇杆。大大降低无人机在控制上的成本。
4. 
# Abs...

# 目录
[TOC]

---------


## 术语说明
1. 本系统中提到的移动设备、手机等特指搭载iOS系统的iPhone，iPad等设备。
2. 本系统中提到的Cube、外设、嵌入式设备特指本系统中负责mavlink协议接受转换的嵌入式系统。
3. 本系统中提到的开发机，特指开发本系统软件搭载Apple macOS 系统电脑。
----------

# 前言

## 设计意义
此系统除了实现使用移动设备重力感应控制无人机的功能外，另一方面提供了一种思路，即如何让移动设备在本身硬件不支持某种无线通信方式时，和目标进行数据通信。

在本系统中，控制目标接收经过调制后的PPM信号，而移动设备本身并不能调制发送这种类型的信号。经过此系统调制后，目标就可以正确接收控制信号了。
## 设计依据

### TCP通信
【reference TCP， wiki， 知网】

### usbmuxd通信

usbmuxd是【reference usbmuxd】 ，此通信方式可以将TCP数据包转发至USB，与iOS设备通信。即可以实现使用数据线与iOS设备指定端口通信的能力。

usbmuxd通过IPC，即进程间通信的方式与请求者进行数据交换，在Unix体系系统中，通过创建unix套接字提供服务。请求方可以向usbmuxd服务发送两种命令，一是设备监听枚举，二是目标连接。一旦usbmuxd与请求方握手成功并进入一种命令模式，请求方必须向usbmuxd服务创建一个新的连接才能发送另一个命令。usbmuxd服务在监听模式下，会向请求方回调当前插入的设备与拔出的设备。在目标连接模式下，请求方向usbmuxd服务发送连接请求，一旦连接建立，请求方向usbmuxd发送的所有数据都会转发到目标iOS设备的指定端口。

#### usbmuxd协议
usbmuxd协议包由两部分组成：包头与负载。其中包头为二进制格式，负载为xml格式的字符串。
usbmuxd包头由4部分组成，以网络字节序编码:

**UsbmuxdHeader**
字段|长度|备注
----|----|----
长度|4字节|包括包头长度
版本|4字节|0为二进制版本，1为plist版本
消息类型|4字节|参见UsbmuxdMessageType，当版本为1时，消息类型需为plist消息

**UsbmuxdMessageType**
字段|值
----|---
请求结果|1
连接请求|2
设备监听请求|3
设备接入|4
设备拔出|5
plist消息|8

由于Apple在最新的系统更新中移除了对二进制usbmuxd协议的支持，所以我们只能使用plist格式的负载小usbmuxd服务传递参数。

负载使用的plist格式类似于xml，是Apple的属性列表，可用于序列化储存数字、布尔、字符串、字典、数组等。【reference plist】

一个plist格式的请求也需要带有UsbmuxdHeader包头，其中包头版本为1，消息类型为8. 负载的属性列表必须包含以下键值对。

键|值类型|备注
--|------|----
MessageType|字符串|消息类型

其中消息类型支持以下几种：
字段|备注
---|---
Listen|设备监听请求
Connect|连接请求
Result|请求结果
Attach|设备接入
Detached|设备拔出

对于不同的消息类型，在负载中应有消息对应的参数键值对。

#### 设备监听请求

#### 设备连接请求

### mavlink协议
【reference mavlink， wiki， 知网】
### PPM协议
【reference PPM， wiki， 知网】
### iOS系统
【reference iOS， wiki，the iPhone wiki， developer.apple.com】
### Linux系统
【reference wiki， 】
## 设计内容
系统总体架构图如下图所示
【架构图】
从硬件上，系统一共分为三部分：移动设备，外设，高频头。
### 移动设备
移动设备是本系统中直接与使用者交互的部分，使用者可以通过移动设备的重力感应来控制无人机。为了实现对应功能，在软件上，将此部分分为三层
1. UI层：用于展示操作控件，信息，处理使用者与移动设备交互动作。
2. 通信层：用于与外设使用特定的协议进行数据通信。
3. 重力感应控制层：封装iOS 重力感应控制API，使其更加适合本系统，有效得统一管理。
### 外设
外设负责处理移动设备发送的控制协议，将mavlink控制协议处理后，转换为高频头的PPM输入信号。软件部分分为3层：
1. 核心逻辑层：此层用于处理各种转换逻辑，同时也是外设程序入口。
2. 通信层：用于与移动设备使用特定的协议进行数据通信。
3. PPM信号转换层：调用外设板级资源，将mavlink控制信号转换为PPM控制信号。
### 高频头
由于无人机接收机接收到有效的控制信号为进过调制后的PPM信号，因此需要一个硬件做这样的信号调制。此组件唯一的功能就是PPM信号调制。

## 文献综述
【TODO】

-------------

# 总体方案确定

## 方案比较

经过前期调研，基本确定了两种实现方案。
1. 使用移动设备+外设+高频头
2. 使用移动设备+外设+PPM调制芯片+高频头

两者最大的差别在与PPM调制方式上，方案一使用外设嵌入式板级GPIO资源，通过软件模拟的方式让GPIO口发送PPM信号。
而方案二加入了一块PPM调制芯片，使用串口向调制芯片发送PPM信号各通道数据，让PPM调制芯片专门负责PPM信号调制。


## 方案选择

### 通信方案

iOS设备与外部设备通信方式非常有限：
1. MFi
2. BLE 蓝牙
3. WiFi
4. 蜂窝数据
5. usbmuxd

MFi作为Apple官方认证的通信方式，允许iOS设备与外设【reference Apple MFi guide】。但是此方案需要在企业层面与Apple合作，在外设中加入加密芯片，开发成本过高。不适合此系统的设计规模。
BLE、WiFi、和蜂窝数据都是无线通信方式，在考虑信道带宽的同时也要考虑稳定性，由于本系统需要较高的可靠性和鲁棒性，故不选择。
usbmuxd通信方式【reference wiki】，满足本系统对成本和可靠性的需求。

### 硬件方案

对于硬件上的两个方案，更多的从软件成本上做了选择。方案一虽然可以减少硬件成本，和方案二相比少了一颗调制IC与其外围元件的价格，但是从软件开发成本上考虑就高了很多。首先外设的软件运行在嵌入式Linux系统上，而嵌入式Linux系统的实时性不高，系统需要使用更多的时间做线程上下文切换，分配给每个线程的时间片也不同。这就会导致GPIO口输出反转的时序不精确。在直接使用bash和文件操作的方法循环翻转一个GPIO口的输出，使用逻辑分析仪测得翻转延时最低为5ms，而PPM信号低电平触发时间为0.3ms，这远远不能满足时序要求。
其次如果直接操作CPU寄存器控制IO口，虽然测的翻转延时可以到0.001ms，但是由于系统级别的线程或者进程管理，导致不能精确延时。实际测得1.2ms高电平延时，实际可能会超时到2ms甚至更长。这也是不能满足PPM信号要求的。
对比其他嵌入式实时操作系统，Linux在GPIO信号控制的表现实在不能满足系统的需求。如果想让Linux提供一个实时环境，我们可以通过编写内核驱动，调用系统中断的方式实现，或者使用【Xenomen】的大小核方式，为Linux提供一个实时内核环境。但是不论哪种方式，对系统整体来说，提高了软件开发成本与学习成本。
最后决定使用加一颗串口转PPM的芯片用于输出PPM信号，加上外围原价，硬件成本只增加了9元。

### 软件方案

本系统涉及2门编程语言（C++，Objective-C），3个操作系统平台(Linux, macOS, 嵌入式Linux)，为了最大限度地重用代码，同时降低各模块之间的耦合。
我们将通信层作为移动设备和外设的通用组件，使其一套代码可以跨平台运行。故使用C++ 11作为编写语言，使用CMake作为构建系统。其次，由于外设运行在嵌入式Linux系统中，因其运算性能限制，不能直接在这个系统上编写调试程序。为了解决这个问题，设计了两种软件调试方法。

1. 使用交叉编译工具连，在目标系统，即外设的嵌入式Linux中运行gdb进行远程调试，观察堆栈即输出。
2. 由于目标嵌入式系统为Linux，而开发平台为Apple公司的macOS系统，这两个操作系统虽然内核不同，但本质上都是UNIX-like系统，系统的输入输出接口都符合POSIX风格。其次在外设代码并没有非常多的平台相关代码。所以我们在设计外设软件的时候，只需要为平台相关代码设计一个统一接口，让不同平台实现这个接口，就可以直接在开发机上调试外设程序了。

这两种调试方法有不同的使用场景，方案一主要在开发机上单元测试通过，部署到外设后进行。而方案二是为了提高开发效率设计的，主要为了检查软件逻辑错误。

为了兼顾跨平台构建的需求，我们在系统开发中使用了CMake，但是如何设计构建逻辑也是我们需要考虑的一个问题。对于移动设备软件的开发我们使用Xcode作为编译构建工具，而CMake同时可以生成Xcode工程项目，所以我们可以将部分跨平台组件生成为Xcode工程，在主工程中引入，Xcode编译时就可以自动寻找相关源文件，编译链接了。
但是对于外设的程序，我们就不能使用Xcode作为构建工具了。在方案设计的时候，我们把外设的程序分为了三层，为了这三层互相解耦，我们需要把通信层和PPM信号转换层编译为静态链接库，同时向核心层暴露接口。在这样的设计下，每层都可以有自己的单元测试，需要测试特定功能模块时，就不需要编译整个外设软件了。

在明确构建系统需要面对的问题和构建需求了，我们就能很好得设计出下图所示的工程目录结构与构建逻辑了
【工程目录】
【构建逻辑】

为了方便编译调试，我们为需要跨平台调试的组件编写交叉编译和非交叉编译两套构建脚本。脚本逻辑如下图所示
【构建脚本逻辑】

-------------

# 理论分析及设计

## 理论计算与分析

### 重力感应控制原理
### Usbmuxd通信原理
### 串口通信原理


## 系统、配件、程序设计
### 系统架构设计
### 数据流设计
### 通信协议设计
### 硬件设计

### 通信层代码设计
#### 通信接口
#### 事件回调
#### 运行循环
#### 线程安全

### 重力感应控制层代码设计
#### 接口设计
#### 多数据获取

### APP设计
#### 链路管理模块
#### mavlink数据包监听分发模块
#### 通道绑定模块
#### 控制反馈模块
#### 姿态指示控件

### 外设控制程序设计
#### mavlink数据包监听分发模块
#### 持久化储存模块
#### PPM信号转换接口设计
#### 链路管理模块

### 仿真系统设计
#### PX4 仿真系统接入

## 外设元器件选择
外设由三大部分组成
1. 嵌入式Linux核心板
2. 电源模块
3. PPM发射模块

其中嵌入式Linux核心板选择了friendlyarm NanoPi NEO。使用锂电池充放电模块和升压板作为电源模块。使用【Multi？？高频头】和UART转PPM模块作为PPM发射模块，专门处理PPM信号。

friendlyarm NanoPi NEO采用了allwinner H3 SOC，可以运行debian, Ubuntu等多个Linux发行版，便于开发部署软件。
使用了3000mAH的锂电池和【充电板型号】，可以实现4小时续航，并且支持边充边放。

-------------

# 测试与实验分析
## 测试、调试结果与分析
## 模型制作、加工
## 实验、仿真结果与分析

---------------

# 总结

---------

# 参考文献

--------

# 附录

---------

# 致谢

--------
